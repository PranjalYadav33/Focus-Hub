name: ğŸš€ Deploy Memphis Focus Hub PWA to GitHub Pages

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ”§ Generate PWA files for production
        run: |
          echo "ğŸ”§ Generating PWA files for production..."
          npm run generate-pwa:prod
          echo "âœ… PWA files generated"
          ls -la public/
        env:
          NODE_ENV: production

      - name: ğŸ—ï¸ Build Memphis Focus Hub with Vite
        run: |
          echo "ğŸ—ï¸ Building application..."
          npx vite build
          echo "âœ… Build completed"
          echo "ğŸ“ Dist contents:"
          ls -la dist/
        env:
          NODE_ENV: production

      - name: ğŸ“‹ Copy PWA files to dist
        run: |
          echo "ğŸ“‹ Ensuring PWA files are in dist directory..."
          cp public/manifest.json dist/manifest.json
          cp public/sw.js dist/sw.js
          cp public/app-icon.svg dist/app-icon.svg
          echo "âœ… PWA files copied to dist"

      - name: âœ… Validate PWA files
        run: |
          echo "ğŸ” Checking PWA files..."
          if [ ! -f "dist/manifest.json" ]; then
            echo "âŒ manifest.json not found in dist/"
            exit 1
          fi
          if [ ! -f "dist/sw.js" ]; then
            echo "âŒ sw.js not found in dist/"
            exit 1
          fi
          if [ ! -f "dist/app-icon.svg" ]; then
            echo "âŒ app-icon.svg not found in dist/"
            exit 1
          fi
          echo "âœ… All PWA files present"
          
          # Check manifest content
          if grep -q "/Focus-Hub/" "dist/manifest.json"; then
            echo "âœ… Manifest has correct GitHub Pages base path"
          else
            echo "âŒ Manifest missing GitHub Pages base path"
            exit 1
          fi
          
          # Check service worker content
          if grep -q "BASE_PATH = '/Focus-Hub'" "dist/sw.js"; then
            echo "âœ… Service worker has correct base path"
          else
            echo "âŒ Service worker missing correct base path"
            exit 1
          fi
          
          echo "ğŸ‰ PWA validation successful!"

      - name: ğŸ“Š PWA Performance Check
        run: |
          echo "ğŸ“Š Checking PWA performance metrics..."
          
          # Check file sizes
          echo "ğŸ“ File sizes:"
          du -h dist/manifest.json
          du -h dist/sw.js
          du -h dist/app-icon.svg
          
          # Check manifest structure
          echo "ğŸ“‹ Manifest structure:"
          cat dist/manifest.json | jq '.name, .start_url, .scope, .display' || echo "jq not available, skipping JSON validation"
          
          # Count cached resources in service worker
          CACHED_RESOURCES=$(grep -o "urlsToCache = \[" -A 20 dist/sw.js | grep -c "https://\|BASE_PATH" || echo "0")
          echo "ğŸ—‚ï¸ Service worker caches $CACHED_RESOURCES resources"
          
          echo "âœ… Performance check completed"

      - name: ğŸ” Final deployment check
        run: |
          echo "ğŸ” Final pre-deployment validation..."
          
          # Ensure all critical files exist
          REQUIRED_FILES=("index.html" "manifest.json" "sw.js" "app-icon.svg" "404.html")
          for file in "${REQUIRED_FILES[@]}"; do
            if [ -f "dist/$file" ]; then
              echo "âœ… $file exists"
            else
              echo "âŒ $file missing"
              exit 1
            fi
          done
          
          # Check if assets directory exists
          if [ -d "dist/assets" ]; then
            echo "âœ… Assets directory exists"
            echo "ğŸ“ Assets count: $(ls dist/assets | wc -l) files"
          else
            echo "âŒ Assets directory missing"
            exit 1
          fi
          
          echo "ğŸš€ Ready for deployment!"

      - name: ğŸ“ Create deployment summary
        run: |
          echo "ğŸ“ Creating deployment summary..."
          echo "## ğŸš€ Memphis Focus Hub PWA Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… PWA Features Deployed:" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“± Progressive Web App with offline support" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ”„ Service Worker with advanced caching" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“‹ Web App Manifest for installation" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ¯ GitHub Pages optimized paths" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“Š Background sync capabilities" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸŒ Offline-first architecture" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸŒ Access URLs:" >> $GITHUB_STEP_SUMMARY
          echo "- **Live Site**: https://pranjalyadav33.github.io/Focus-Hub/" >> $GITHUB_STEP_SUMMARY
          echo "- **PWA Install**: Add to home screen from the live site" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ‰ **Deployment successful!** The PWA is now available with full offline capabilities." >> $GITHUB_STEP_SUMMARY

      - name: ğŸ“„ Setup Pages
        uses: actions/configure-pages@v5
        if: github.ref == 'refs/heads/main'

      - name: ğŸ“¤ Upload artifact
        uses: actions/upload-pages-artifact@v3
        if: github.ref == 'refs/heads/main'
        with:
          path: ./dist

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    steps:
      - name: ğŸš€ Deploy Memphis Focus Hub PWA to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
